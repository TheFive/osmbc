# Installation Guide for OSMBC

  1. [Dependencies](#1---dependencies)
  2. [Configuration files](#2---configuration-files)
    - [Examples of use (for after)](#examples-of-use-for-after)
  3. [Node's global modules](#3---nodes-global-modules)
  4. [Node's local modules](#4---nodes-local-modules)
    - [Locking versions](#locking-versions)
  5. [Database](#5---database)
    - [Creating tables and views](#creating-tables-and-views)
    - [Import files from](#import-files-from)

## 1 - Dependencies

Before you install OSMBC the following Software has to be installed.

**a)** Postgres 9.3 or higher

The system is tested and developed under `9.3`, as far as i know all features
used should work with `9.4`.

**b)** Node.JS 10.* or higher

OSMBC runs with `4.2.4` on the development machine and with `4.2.3` on the production server.

## 2 - Configuration files

OSMBC puts main configuration in a file with the name config.?.json, where ? can be
test or development or production.

The config.test.json is checked in and used in parallel for test on travis-ci server or the local machine.
Insofar it is important, to use the same credentials on the local machine, than on travis-ci.
Parallel you can create an own config config.testlocal.json and set NODE_ENV to testlocal to use
your testfile.

The config.developent.json is not checked in, so it may contain the passwords to your postgres installation,
and to the other integrated tools.

The config.production.json should be used for a production environment, so you can have for each usage szenario
an own config. config.development.json and config.production.json are listed in .gitignore, so that no passwords
are pushed to github.

To generate your first config file, please copy the config.test.json as start.


```json
 "serverport": 35043,
  
  "postgres": {
    "initialise": true,
    "database" : "localhost:5432/osmbc",
    "username" : "TheFive",
    "password" : "thefive",
    "connectstr" : "psql://test:test@localhost:5432/testdb"
  },
   "twitter":{
    "consumer_key": "dummy",
    "consumer_secret": "dummy",
    "access_token": "dummy",
    "access_token_secret": "dummy"
    },

  "slack":{
    "blog":{
      "DE":{
        "hook":"https://hooks.slack.com/services/blogKey",
        "channel":"#osmbcblog"
      },
      "default":{
        "hook":"https://hooks.slack.com/services/blogKeyWeekly",
        "channel":"#osmbcblog"
      }
    },
    "article":{
      "wn":{
        "hook":"https://hooks.slack.com/services/articleKey",
        "channel":"#osmbcarticle"
      }
    }
  },
 
  "AppName":"TESTBC",
  "languages":["DE","EN","ES"],
  "callbackUrl":"http://localhost:3000/auth/openstreetmap/callback",
  "OPENSTREETMAP_CONSUMER_KEY" : "######",
  "OPENSTREETMAP_CONSUMER_SECRET" : "#####",
  "htmlroot":"",
  "bootstrap":"http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5",
  "ReviewInWP":["DE"],
  "EmailSender":"noreply@gmail.com",
  "url":"https://testosm.bc",
  "SMTP":"smtps not defined, as all mails should be mocked by sinon in test",
  "sessionStore":"connect-pg-simple"

```

Where:

- `serverport` is the port in that the node server is listening
- `database` is the string of accesse to Postgres
- `username` is the username on Postgres
- `password` is the password on Postgres
- `connectstr` is the string of access to Postgres
	- **Overwrites `database`, `username` and `password`**
- `callbackUrl` is the URL of callback for the OAuth mechanism
	- **You must change the serverport**
- `OPENSTREETMAP_CONSUMER_KEY` is the OAuth Key
	- Generate it from your user properties in OSM
- `OPENSTREETMAP_CONSUMER_SECRET`is the OAuth Secret
	-  Generate it from your user properties in OSM
- `htmlroot`is the root for the HTML path to be used to handle multiple instances in a same server
	- e.g. `MYSERVER/<htmlroot>/osmbc.html`
- `slack` There are two slack configurations, the blog and the article configuration.
    - with the blog configuration you can have a slack hook per language to write 
    - changes about the blog status (review...) in a separate slack channel for each
    - language. Use default for all languages, that should use a common channel.
    - the article part allowes to have multiple slack channels to write 
    - all information about an article to.
    - you can get the hook out of your slack integration. Channel is the channel name
    - with @ or # as first character
- `twitter` Put in your consumer secrets like offered by twitter.
    - the twitter API is used to parse the tweets and expand all urls in a tweet.
-  `AppName` The name in the upper left corner of the APP and in each mail generated by the App.
-  `languages` the supported languages.
-  `bootstrap` root to bootstap, if you do not want to use the one our of the public folder.
-  `ReviewInWP` define the languages, that are direct marked as exported, as soon as the review
    - has started. (The Review will take place in WordPress).
-  `EmailSender` define the email adress of all outgoing emails.
-  `url`  the basic url
    - - e.g. `url/<htmlroot>/osmbc.html`
    
-  `smtp` smtp adress (with uername password) to send emails.
-  `sessionStore` used to configure the session store. 
    - connect-pg-simple is recommended
    - session-file-store is an alternative file based NPM Lib.
	
	

Please configure your config files  `package.json` for npm start and npm test.

### Examples of use (for after)

The config module uses development as default configuration (if it is not set via `NODE_ENV` variable).

```console
$ npm start  # sets NODE_ENV=development
```

```console
$ npm test  # sets NODE_ENV=test
```

## 3 - Node's global modules

Please install the following node modules global:

```console
$ sudo npm install istanbul -g  # used for Codecoverage during npm test
$ sudo npm install mocha -g  # used for tests during npm test
```

## 4 - Node's local modules

After checkout of OSMBC please install all necessary modules in its directory doing there:

```console
$ npm install
```

Depending on machine configuration, you may need doing this as root.

### Locking versions

Probably you use a NodeJS newer than the supported by OSMBC. Especially if you use a rolling release distribution such as the Arch Linux that today have NodeJS v4.2.1.

The solution for this is using `nvm` — _Node Version Manager_:

1. Install the [nvm]
    - On Arch Linux:
    ```console
    $ yaourt -S nvm
    $ echo 'source /usr/share/nvm/init-nvm.sh' >> ~/.bashrc  # if yaourt was ok
    ```
    - If Ubuntu, see (in portuguese): [Como Instalar o Node.js em um Servidor Ubuntu 14.04][ubuntu-nvm-ref]
    - If other distro, see the official instrutions at GitHub [creationix/nvm][nvm]
    - If Windows, use [nvmw] or [nvm-windows]
2. Choose the NodeJS version
    - Our develepment machine uses the **`0.12.4`**
    ```console
    $ nvm install 0.12.4
    ```
3. Choose the Python version
    - Switch to **2** at `npm install` if necessary:
    ```console
    $ rm -rf node_modules  # take care with the rm -rf
    $ npm install --python=python2.7  # because I use Python 3 by default
    ```

[ubuntu-nvm-ref]: https://www.digitalocean.com/community/tutorials/como-instalar-o-node-js-em-um-servidor-ubuntu-14-04-pt
[nvm]: https://github.com/creationix/nvm
[nvmw]:  https://github.com/hakobera/nvmw
[nvm-windows]: https://github.com/coreybutler/nvm-windows

## 5 - Database

The database can be installed using the two javascript files that are **in the folder `import`**.

### Creating tables and views and the first uster

_→ See also: section about [Configuration files](#2---configuration-files), for database access_

```sh
NODE_ENV=???? node createdb.js
```

Where `???` is the configuration that you want to use (e.g. `development` or `test`).
Use createdb.js with the --verbose option, to see the differences between the expected db structure & the real db structure.
(For now there is a more detailed analyses of the indexes, no analyses for the rest).
To create the full database run it with the option --createTable --createIndex --createView, this expects an empty database.
If there are already tables and views you can drop them with --dropTable --dropIndex and --dropView. Please make sure to have a 
backup of your productive data, before doing that.

To update to the acutal set of indexes just user --updateIndex. (--updateNAME option is for now only available for indexes).


### Import files from

There is a script to import all the weekly news down from [blog.openstreetmap.de](http://blog.openstreetmap.de).

To import the first blog (the of number 268), call:

```sh
NODE_ENV=???? node download.js
```

For now the first (admin) user has to be created with psql. OSMBC offers only OAUTH authentification via OpenStreetMap, so you have to have a OSM Account and give that
user access to your OSMBC instance.

```psql
insert into usert (data) values ('{"OSMUser":"?? your osm user name ??","access":"full"}');
```


But of course it will be better to ask the Weekly - Wochennotiz team, to get a SQL dump.